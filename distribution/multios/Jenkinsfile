// MultiOS Jenkins Pipeline

pipeline {
    agent none
    
    environment {
        CARGO_TERM_COLOR = 'always'
        RUST_BACKTRACE = '1'
    }
    
    options {
        buildDiscarder(logRotator(numToKeepStr: '10'))
        timeout(time: 2, unit: 'HOURS')
        ansiColor('xterm')
    }
    
    stages {
        stage('Prepare') {
            parallel {
                stage('Validate Environment') {
                    agent {
                        docker {
                            image 'rust:1.70'
                        }
                    }
                    steps {
                        sh 'rustc --version'
                        sh 'cargo --version'
                        sh 'qemu-system-x86 --version || echo "QEMU not available"'
                    }
                }
                
                stage('Install Dependencies') {
                    agent {
                        docker {
                            image 'rust:1.70'
                        }
                    }
                    steps {
                        sh '''
                            apt-get update
                            apt-get install -y qemu-system-x86 qemu-system-aarch64 qemu-system-riscv64 \\
                                gcc-aarch64-linux-gnu gcc-riscv64-linux-gnu \\
                                doxygen graphviz
                        '''
                        sh 'cargo install cargo-audit cargo-tarpaulin cross'
                    }
                }
            }
        }
        
        stage('Lint and Format') {
            agent {
                docker {
                    image 'rust:1.70'
                }
            }
            steps {
                sh 'cargo fmt --all -- --check'
                sh 'cargo clippy --all-targets --all-features -- -D warnings'
                sh 'cargo doc --no-deps --all-features'
            }
            post {
                always {
                    publishHTML([
                        allowMissing: false,
                        alwaysLinkToLastBuild: true,
                        keepAll: true,
                        reportDir: 'target/doc',
                        reportFiles: 'index.html',
                        reportName: 'Documentation'
                    ])
                }
            }
        }
        
        stage('Security Audit') {
            agent {
                docker {
                    image 'rust:1.70'
                }
            }
            steps {
                sh 'cargo audit'
            }
            post {
                always {
                    publishHTML([
                        allowMissing: true,
                        alwaysLinkToLastBuild: true,
                        keepAll: false,
                        reportDir: '.',
                        reportFiles: 'audit_report.html',
                        reportName: 'Security Audit'
                    ])
                }
            }
        }
        
        stage('Unit Tests Matrix') {
            parallel {
                stage('Test x86_64') {
                    agent {
                        docker {
                            image 'rust:1.70'
                        }
                    }
                    steps {
                        sh '''
                            cd tests/unit
                            cargo test
                        '''
                    }
                    post {
                        always {
                            junit 'test-results/**/*.xml'
                            publishHTML([
                                allowMissing: true,
                                alwaysLinkToLastBuild: true,
                                keepAll: false,
                                reportDir: 'test-results',
                                reportFiles: '*.html',
                                reportName: 'Test Results x86_64'
                            ])
                        }
                    }
                }
                
                stage('Test ARM64') {
                    agent {
                        docker {
                            image 'rust:1.70'
                        }
                    }
                    steps {
                        sh '''
                            apt-get install -y gcc-aarch64-linux-gnu
                            cd tests/unit
                            cargo test --target aarch64-unknown-none
                        '''
                    }
                    post {
                        always {
                            junit 'test-results/**/*.xml'
                            publishHTML([
                                allowMissing: true,
                                alwaysLinkToLastBuild: true,
                                keepAll: false,
                                reportDir: 'test-results',
                                reportFiles: '*.html',
                                reportName: 'Test Results ARM64'
                            ])
                        }
                    }
                }
                
                stage('Test RISC-V64') {
                    agent {
                        docker {
                            image 'rust:1.70'
                        }
                    }
                    steps {
                        sh '''
                            apt-get install -y gcc-riscv64-linux-gnu
                            cd tests/unit
                            cargo test --target riscv64gc-unknown-none
                        '''
                    }
                    post {
                        always {
                            junit 'test-results/**/*.xml'
                            publishHTML([
                                allowMissing: true,
                                alwaysLinkToLastBuild: true,
                                keepAll: false,
                                reportDir: 'test-results',
                                reportFiles: '*.html',
                                reportName: 'Test Results RISC-V64'
                            ])
                        }
                    }
                }
            }
        }
        
        stage('Integration Tests') {
            agent {
                docker {
                    image 'rust:1.70'
                }
            }
            steps {
                sh '''
                    cd tests/integration
                    cargo test
                '''
            }
            post {
                always {
                    junit 'test-results/**/*.xml'
                    publishHTML([
                        allowMissing: true,
                        alwaysLinkToLastBuild: true,
                        keepAll: false,
                        reportDir: 'test-results',
                        reportFiles: '*.html',
                        reportName: 'Integration Test Results'
                    ])
                }
            }
        }
        
        stage('QEMU Tests Matrix') {
            parallel {
                stage('QEMU x86_64') {
                    agent {
                        docker {
                            image 'rust:1.70'
                        }
                    }
                    steps {
                        sh './scripts/test.sh --target x86_64 --suite unit --qemu'
                    }
                    post {
                        always {
                            archiveArtifacts artifacts: 'test-results/**/*', allowEmptyArchive: true
                            publishHTML([
                                allowMissing: true,
                                alwaysLinkToLastBuild: true,
                                keepAll: false,
                                reportDir: 'test-results',
                                reportFiles: '*.html',
                                reportName: 'QEMU Test Results x86_64'
                            ])
                        }
                    }
                }
                
                stage('QEMU ARM64') {
                    agent {
                        docker {
                            image 'rust:1.70'
                        }
                    }
                    steps {
                        sh '''
                            apt-get install -y gcc-aarch64-linux-gnu
                            ./scripts/test.sh --target arm64 --suite unit --qemu
                        '''
                    }
                    post {
                        always {
                            archiveArtifacts artifacts: 'test-results/**/*', allowEmptyArchive: true
                            publishHTML([
                                allowMissing: true,
                                alwaysLinkToLastBuild: true,
                                keepAll: false,
                                reportDir: 'test-results',
                                reportFiles: '*.html',
                                reportName: 'QEMU Test Results ARM64'
                            ])
                        }
                    }
                }
                
                stage('QEMU RISC-V64') {
                    agent {
                        docker {
                            image 'rust:1.70'
                        }
                    }
                    steps {
                        sh '''
                            apt-get install -y gcc-riscv64-linux-gnu
                            ./scripts/test.sh --target riscv64 --suite unit --qEMU
                        '''
                    }
                    post {
                        always {
                            archiveArtifacts artifacts: 'test-results/**/*', allowEmptyArchive: true
                            publishHTML([
                                allowMissing: true,
                                alwaysLinkToLastBuild: true,
                                keepAll: false,
                                reportDir: 'test-results',
                                reportFiles: '*.html',
                                reportName: 'QEMU Test Results RISC-V64'
                            ])
                        }
                    }
                }
            }
        }
        
        stage('Code Coverage') {
            agent {
                docker {
                    image 'rust:1.70'
                }
            }
            steps {
                sh '''
                    mkdir -p coverage_report
                    cargo tarpaulin --out html --output-dir coverage_report
                    cargo tarpaulin --out xml --output-dir coverage_report
                '''
            }
            post {
                always {
                    publishHTML([
                        allowMissing: false,
                        alwaysLinkToLastBuild: true,
                        keepAll: true,
                        reportDir: 'coverage_report',
                        reportFiles: 'index.html',
                        reportName: 'Code Coverage Report'
                    ])
                }
            }
        }
        
        stage('Build Matrix') {
            parallel {
                stage('Build x86_64') {
                    agent {
                        docker {
                            image 'rust:1.70'
                        }
                    }
                    steps {
                        sh './scripts/build.sh --target x86_64 --release'
                        archiveArtifacts artifacts: 'dist/**/*', fingerprint: true
                    }
                }
                
                stage('Build ARM64') {
                    agent {
                        docker {
                            image 'rust:1.70'
                        }
                    }
                    steps {
                        sh '''
                            apt-get install -y gcc-aarch64-linux-gnu
                            ./scripts/build.sh --target arm64 --release
                        '''
                        archiveArtifacts artifacts: 'dist/**/*', fingerprint: true
                    }
                }
                
                stage('Build RISC-V64') {
                    agent {
                        docker {
                            image 'rust:1.70'
                        }
                    }
                    steps {
                        sh '''
                            apt-get install -y gcc-riscv64-linux-gnu
                            ./scripts/build.sh --target riscv64 --release
                        '''
                        archiveArtifacts artifacts: 'dist/**/*', fingerprint: true
                    }
                }
            }
        }
        
        stage('Documentation') {
            agent {
                docker {
                    image 'rust:1.70'
                }
            }
            steps {
                sh '''
                    cargo doc --no-deps --all-features
                    mkdir -p docs/generated
                    cp -r target/doc/* docs/generated/
                '''
            }
            post {
                always {
                    publishHTML([
                        allowMissing: false,
                        alwaysLinkToLastBuild: true,
                        keepAll: true,
                        reportDir: 'docs/generated',
                        reportFiles: 'index.html',
                        reportName: 'Generated Documentation'
                    ])
                }
            }
        }
        
        stage('Performance Benchmarks') {
            agent {
                docker {
                    image 'rust:1.70'
                }
            }
            when {
                anyOf {
                    branch 'main'
                    buildingTag()
                }
            }
            steps {
                sh '''
                    cd tests/benchmarks
                    cargo bench
                '''
            }
            post {
                always {
                    archiveArtifacts artifacts: 'benchmark_results/**/*', allowEmptyArchive: true
                }
            }
        }
        
        stage('Deploy Staging') {
            agent {
                docker {
                    image 'rust:1.70'
                }
            }
            when {
                branch 'staging'
            }
            environment {
                DEPLOY_ENV = 'staging'
            }
            steps {
                sh '''
                    echo "Deploying to staging environment"
                    # Add staging deployment commands here
                '''
            }
        }
        
        stage('Deploy Production') {
            agent {
                docker {
                    image 'rust:1.70'
                }
            }
            when {
                anyOf {
                    branch 'main'
                    buildingTag()
                }
            }
            environment {
                DEPLOY_ENV = 'production'
            }
            input {
                message "Deploy to production?"
                ok "Deploy"
                submitter "multios-team"
            }
            steps {
                sh '''
                    echo "Deploying to production environment"
                    # Add production deployment commands here
                '''
            }
        }
    }
    
    post {
        always {
            script {
                if (currentBuild.result == 'FAILURE' || currentBuild.result == 'UNSTABLE') {
                    emailext(
                        subject: "Build Failed: ${env.JOB_NAME} - ${env.BUILD_NUMBER}",
                        body: """
                        Build Result: ${currentBuild.result}
                        Build URL: ${env.BUILD_URL}
                        Git Commit: ${env.GIT_COMMIT}
                        Branch: ${env.GIT_BRANCH}
                        
                        Please check the build logs for details.
                        """,
                        to: "${env.CHANGE_AUTHOR_EMAIL}",
                        recipientProviders: [developers(), requestor()]
                    )
                }
            }
        }
        
        success {
            emailext(
                subject: "Build Successful: ${env.JOB_NAME} - ${env.BUILD_NUMBER}",
                body: """
                Build completed successfully!
                Build URL: ${env.BUILD_URL}
                Git Commit: ${env.GIT_COMMIT}
                Branch: ${env.GIT_BRANCH}
                
                All tests passed and artifacts are available.
                """,
                to: "${env.CHANGE_AUTHOR_EMAIL}",
                recipientProviders: [developers(), requestor()]
            )
        }
        
        cleanup {
            cleanWs()
        }
    }
}