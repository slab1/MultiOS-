# MultiOS GitLab CI/CD Pipeline

stages:
  - validate
  - test
  - build
  - deploy

variables:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

# Cache configuration
cache:
  paths:
    - target/
    - ~/.cargo/registry/
    - ~/.cargo/git/

# Base image for all jobs
.base_job:
  image: rust:1.70
  before_script:
    - apt-get update -qq && apt-get install -y -qq qemu-system-x86 qemu-system-aarch64 qemu-system-riscv64

# Validation stage
lint-and-format:
  extends: .base_job
  stage: validate
  script:
    - rustup component add rustfmt clippy
    - cargo fmt --all -- --check
    - cargo clippy --all-targets --all-features -- -D warnings
    - cargo doc --no-deps --all-features

security-audit:
  extends: .base_job
  stage: validate
  script:
    - cargo install cargo-audit
    - cargo audit

# Unit tests matrix
.test_template: &test_template
  extends: .base_job
  stage: test
  script:
    - cd tests/unit
    - cargo test
  artifacts:
    reports:
      junit: test-results/junit.xml
    paths:
      - test-results/
    expire_in: 1 week

unit-test-x86_64:
  <<: *test_template
  variables:
    TARGET: x86_64

unit-test-arm64:
  extends: .base_job
  stage: test
  script:
    - apt-get install -y gcc-aarch64-linux-gnu
    - cd tests/unit
    - cargo test --target aarch64-unknown-none
  artifacts:
    reports:
      junit: test-results/junit.xml
    paths:
      - test-results/
    expire_in: 1 week

unit-test-riscv64:
  extends: .base_job
  stage: test
  script:
    - apt-get install -y gcc-riscv64-linux-gnu
    - cd tests/unit
    - cargo test --target riscv64gc-unknown-none
  artifacts:
    reports:
      junit: test-results/junit.xml
    paths:
      - test-results/
    expire_in: 1 week

# Integration tests
integration-tests:
  extends: .base_job
  stage: test
  script:
    - cd tests/integration
    - cargo test
  artifacts:
    reports:
      junit: test-results/junit.xml
    paths:
      - test-results/
    expire_in: 1 week

# QEMU testing matrix
.qemu_test_template: &qemu_test_template
  extends: .base_job
  stage: test
  script:
    - ./scripts/test.sh --target $TARGET --suite unit --qemu
  artifacts:
    reports:
      junit: test-results/junit.xml
    paths:
      - test-results/
    expire_in: 1 week

qemu-test-x86_64:
  <<: *qemu_test_template
  variables:
    TARGET: x86_64

qemu-test-arm64:
  extends: .base_job
  stage: test
  script:
    - apt-get install -y gcc-aarch64-linux-gnu
    - ./scripts/test.sh --target arm64 --suite unit --qemu
  variables:
    TARGET: arm64

qemu-test-riscv64:
  extends: .base_job
  stage: test
  script:
    - apt-get install -y gcc-riscv64-linux-gnu
    - ./scripts/test.sh --target riscv64 --suite unit --qemu
  variables:
    TARGET: riscv64

# Coverage analysis
coverage:
  extends: .base_job
  stage: test
  script:
    - cargo install cargo-tarpaulin
    - mkdir -p coverage_report
    - cargo tarpaulin --out html --output-dir coverage_report
    - cargo tarpaulin --out xml --output-dir coverage_report
  coverage: '/^TOTAL.+?(\d+%)$/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage_report/cobertura.xml
    paths:
      - coverage_report/
    expire_in: 1 week

# Build stage matrix
.build_template: &build_template
  extends: .base_job
  stage: build
  script:
    - ./scripts/build.sh --target $TARGET --release
  artifacts:
    paths:
      - dist/$TARGET/
    expire_in: 1 month

build-x86_64:
  <<: *build_template
  variables:
    TARGET: x86_64

build-arm64:
  extends: .base_job
  stage: build
  script:
    - apt-get install -y gcc-aarch64-linux-gnu
    - ./scripts/build.sh --target arm64 --release
  variables:
    TARGET: arm64

build-riscv64:
  extends: .base_job
  stage: build
  script:
    - apt-get install -y gcc-riscv64-linux-gnu
    - ./scripts/build.sh --target riscv64 --release
  variables:
    TARGET: riscv64

# Documentation generation
documentation:
  extends: .base_job
  stage: build
  script:
    - cargo doc --no-deps --all-features
    - mkdir -p docs/generated
    - cp -r target/doc/* docs/generated/
  artifacts:
    paths:
      - docs/generated/
    expire_in: 1 week

# Performance benchmarks
benchmarks:
  extends: .base_job
  stage: test
  only:
    - main
  script:
    - cd tests/benchmarks
    - cargo bench
  artifacts:
    paths:
      - benchmark_results/
    expire_in: 1 week

# Docker image for distribution
docker-build:
  extends: .base_job
  stage: build
  services:
    - docker:dind
  variables:
    DOCKER_DRIVER: overlay2
  script:
    - docker build -t $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA .
    - docker push $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA
  only:
    - main
    - tags

# Staging deployment
deploy-staging:
  extends: .base_job
  stage: deploy
  environment:
    name: staging
    url: https://staging.multios.org
  script:
    - echo "Deploying to staging environment"
    - # Add staging deployment commands here
  only:
    - staging

# Production deployment
deploy-production:
  extends: .base_job
  stage: deploy
  environment:
    name: production
    url: https://multios.org
  script:
    - echo "Deploying to production environment"
    - # Add production deployment commands here
  only:
    - tags